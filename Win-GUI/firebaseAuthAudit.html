<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>CryptoAlgo | Login</title>
        <link rel="stylesheet" href="assets/css/main.css" />
        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-app.js"></script>

        <script src="assets/js/jquery.min.js" sync></script>

        <!-- TODO: Add SDKs for Firebase products that you want to use
                https://firebase.google.com/docs/web/setup#available-libraries -->
        <script src="https://www.gstatic.com/firebasejs/ui/4.5.1/firebase-ui-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.15.4/firebase-auth.js"></script>
        <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.5.1/firebase-ui-auth.css" />

        <style>
            .auth {
                border: 2px solid #555;
                border-radius: 7px;
                width: 40%;
                margin: auto;
                padding-top: 5px;
                background-color: #1b1b1b;
            }
            .authInput {
                margin: auto;
            }
            .submitBtn {
                margin: 10px;
            }
            .firebaseui-idp-google {
                background-color: #333 !important;
                border-radius: 7px;
            }
            .authLabels {
                color: white !important;
                font-size: 20px;
                margin-bottom: 5px;
            }
            .firebaseui-idp-google>.firebaseui-idp-text {
                color: white !important;
            }
            .firebaseui-idp-github {
                border-radius: 7px;
            }
            .warningMsgBox {
                background-color: #0063b1;
                margin-top: 10px;
                margin-bottom: 10px;
            }
            .msgBox {
                color: black !important;
                font-weight: 900;
                margin-bottom: 5px;
            }

            .collapsible {
                background-color: #212121 !important;
                color: white;
                cursor: pointer;
                padding-left: 18px;
                padding-right: 18px;
                width: 100%;
                border-color: #555;
                border-style: solid;
                border-width: 2px 0 0 0;
                border-radius: 0px;
                text-align: left;
                outline: none;
                font-size: 15px;
            }

            .active, .collapsible:hover {
                background-color: #666;
            }

            .active {
                border-width: 2px 0 2px 0;
			}

            .collapsible:after {
                content: '\002B';
                color: white;
                font-weight: bold;
                float: right;
                margin-left: 5px;
            }

            .active:after {
                content: "\2212";
            }

            .content {
                padding: 0 18px;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.2s ease-out;
            }
        </style>

        <script>
            // Your web app's Firebase configuration
            var firebaseConfig = {
                apiKey: "AIzaSyDu3GBqQg6o9Mp7Ay6KkTKRnqogZWmhU6c",
                authDomain: "cryptoalgogui.firebaseapp.com",
                databaseURL: "https://cryptoalgogui.firebaseio.com",
                projectId: "cryptoalgogui",
                storageBucket: "cryptoalgogui.appspot.com",
                messagingSenderId: "104602369567",
                appId: "1:104602369567:web:bcfdad88debbb2b8cddf2a",
                measurementId: "G-YT1W6G83B3"
            };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);

            // Initialize the FirebaseUI Widget using Firebase.
            var ui = new firebaseui.auth.AuthUI(firebase.auth());

            // FirebaseUI config.
            var uiConfig = {
                signInSuccessUrl: ' ',
                signInOptions: [
                    // Leave the lines as is for the providers you want to offer your users.
                    firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                    firebase.auth.GithubAuthProvider.PROVIDER_ID
                ],
                // tosUrl and privacyPolicyUrl accept either url string or a callback
                // function.
                // Terms of service url/callback.
                tosUrl: '<your-tos-url>',
                // Privacy policy url/callback.
                privacyPolicyUrl: function() {
                    window.location.assign('<your-privacy-policy-url>');
                }
            };

            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    $('#warningBox1').fadeOut(0);
                    var user = firebase.auth().currentUser;
                    //    user.uid;  // The user's ID, unique to the Firebase project. Do NOT use
                                     // this value to authenticate with your backend server, if
                                     // you have one. Use User.getToken() instead.
                    console.log('Name: ' + user.displayName);
                    console.log('Email: ' + user.email);
                    console.log('Profile Photo: ' + user.photoURL);
                    console.log('Is email verified? ' + user.emailVerified);
                    console.log('User UID: ' + user.uid);
                    // Update page elements
                    document.getElementById("headText").innerHTML = "Welcome to CryptoAlgo";
                    if (user.displayName) { // Check if there's a display name
                        document.getElementById("usrName").innerHTML = "Hello, " + user.displayName;
                    }
                    document.getElementById("usrProfilePic").src = user.photoURL;
                    if (!user.emailVerified) {
                        document.getElementById("usrEmail").innerHTML = user.email + "<br/> Email not verified";
                        $('#verifyEmail').fadeIn();
                    }
                    else {
                        document.getElementById("usrEmail").innerHTML = user.email + "<br/> Email verified";
                    }
                    $('#loginArea').fadeOut(0);
                    $('#profileSpace').fadeIn("slow");
                } else {
                    // The user is not signed in
                    $('#warningBox1').fadeOut(0);
                    document.getElementById("headText").innerHTML = "CryptoAlgo Login";
                    $('#profileSpace').fadeOut(0);
                    $('#loginArea').fadeIn();
                    // The start method will wait until the DOM is loaded.
                    ui.start('#firebaseui-auth-container', uiConfig); // Render the login box
                }
            });

            function emailAuthLogin() {
                firebase.auth().signInWithEmailAndPassword(document.getElementById("username").value, document.getElementById("password").value).catch(function(error) {
                    // Handle Errors here.
                    pushWarning(error.message);
                    console.error(error.message);
                });
            }

            function pushWarning(warningText) {
                document.getElementById("warnings").innerHTML = warningText;
                $('#warningBox').fadeIn();
                setTimeout(function() { 
                    $('#warningBox').fadeOut();
                }, 3000);
                document.getElementById("warnings1").innerHTML = warningText;
                $('#warningBox1').fadeIn();
                setTimeout(function() {
                    $('#warningBox1').fadeOut();
                }, 3000);
                document.getElementById("warnings2").innerHTML = warningText;
                $('#warningBox2').fadeIn();
                setTimeout(function() {
                    $('#warningBox2').fadeOut();
                }, 3000);
            }

            function openAccountCreate() {
                $('#newAccountHint').fadeOut();
                $('#emailLogin').fadeOut(function() {
                    $('#newAccount').fadeIn();
                    $('#backToLogin').fadeIn();
                });
            }

            function verifyEmail() {
                firebase.auth().currentUser.sendEmailVerification().then(function() {
                    pushWarning("Verification email sent");
                    $('#verifyEmail').fadeOut();
                }).catch(function(error) {
                    pushWarning(error);
                });
			}

            var closeOrOpen = true; // True for open
            function usrSettingsCloseOpen() {
                if(closeOrOpen) {  // Open settings
                    $('#profileSettings').fadeIn();
                    $('#settingsBtn').fadeOut(function() {
                        document.getElementById("settingsBtn").innerHTML = "close";
                        $('#settingsBtn').fadeIn();
                    });
                    closeOrOpen = false;
                }
                else {
                    $('#profileSettings').fadeOut();
                    $('#settingsBtn').fadeOut(function() {
                        document.getElementById("settingsBtn").innerHTML = "settings";
                        $('#settingsBtn').fadeIn();
                    });
                    closeOrOpen = true;
                }
            }

            function updateProfile() {
                var newDisplayName = document.getElementById("displayName").value;
                if(newDisplayName.length == 0) {
                    pushWarning("The input is not filled in");
                    return;
                }
                else if(newDisplayName.trim().length == 0) {
                    pushWarning("The input does not have any text");
                    return;
				}
                firebase.auth().currentUser.updateProfile({
                    displayName: newDisplayName
                }).then(function() {
                    // Update successful.
                    location.reload();
                }).catch(function(error) {
                    pushWarning("Failed to update profile");
                    console.error("Failed to update profile:", error);
                });     
            }

            function backToLogin() {
                $('#newAccount').fadeOut();
                $('#backToLogin').fadeOut(function() {
                    $('#newAccountHint').fadeIn();
                    $('#emailLogin').fadeIn();
                });
            }

            function createNewAccount() {
                if(!(document.getElementById("newPassword").value == document.getElementById("confirmPassword").value)) {
                    pushWarning("The passwords do not match");
                    return;
                }
                var passwdTemplate=  /^[A-Za-z]\w{7,64}$/;
                if(document.getElementById("newPassword").value.match(passwdTemplate)) {
                    firebase.auth().createUserWithEmailAndPassword(document.getElementById("newUsername").value, document.getElementById("newPassword").value).catch(function(error) {
                        pushWarning(error.message);
                    });
                }
                else {
                    pushWarning("Please meet the following requirements: 7-64 characters, starting with a letter")
                }
            }

            function signOutUser() {
                if(confirm('Are you sure you want to sign out of CryptoAlgo?')) {
                    firebase.auth().signOut().then(function() {
                        console.log("User signed out");
                        alert('You have been signed out. Thank you for using CryptoAlgo.');
                    }, function(error) {
                        console.error('Sign Out Error', error);
                    });
                }
            }

            function changeUserPassword() {
                if(!(document.getElementById("changePwd").value == document.getElementById("confirmChangePwd").value)) {
                    // The two passwords do not match
                    pushWarning("The passwords do not match");
                    return;
				}
                var passwdTemplate=  /^[A-Za-z]\w{7,64}$/;
                if(document.getElementById("changePwd").value.match(passwdTemplate)) {
                    $('#pwdChange').fadeOut();
                    var userProvidedPassword = document.getElementById("oldPwd").value;
                    var credential = firebase.auth.EmailAuthProvider.credential(
                        firebase.auth().currentUser.email, 
                        userProvidedPassword
                    );
                    firebase.auth().currentUser.reauthenticateWithCredential(credential).then(function() {
                        firebase.auth().currentUser.updatePassword(document.getElementById("changePwd").value).then(function() {
                            // Update successful.
                            alert("Successfully changed password.");
                            $('#pwdChange').fadeIn();
                        }).catch(function(error) {
                            pushWarning(error);
                        });
                    }).catch(function(error) {
                        // An error happened.
                    });
                }
                else {
                    pushWarning("Please meet the following requirements: 7-64 characters, starting with a letter")
                    $('#pwdChange').fadeIn();
				}
			}

            function updateEmail() {
                var userProvidedPassword = document.getElementById("emailChgPwd").value;
                var credential = firebase.auth.EmailAuthProvider.credential(
                    firebase.auth().currentUser.email, 
                    userProvidedPassword
                );
                firebase.auth().currentUser.reauthenticateWithCredential(credential).then(function() {
                    firebase.auth().currentUser.updateEmail(document.getElementById("changeEmail").value).then(function() {
                        pushWarning("Updated email address. Please verify your new email.");
                    }).catch(function(error) {
                        pushWarning(error);
                    });
                }).catch(function(error) {
                    pushWarning(error);
                });
			}
        </script>
    </head>
    <body>
        <section id="one" class="wrapper style2">
            <div style="text-align: center">
                <h2 id="headText"> </h2>

                <div id="profileSpace" style="display: none">
                    <img id="usrProfilePic" onerror="this.src='images/pfpPlaceholder.png'" style="border-radius: 100px" src="" alt="Profile Image" width="100px"></img>
                    <h2 id="usrName" style="text-transform: none; font-weight: bold;">Hello, unknown user</h2>
                    <p id="usrEmail">Email</p>

                    <!-- Warning box (Normally hidden) -->
                    <div class="warningMsgBox auth" onclick="$('#warningBox').fadeOut()" id="warningBox" style="display: none;">
                        <h2 id="warnings" class="msgBox" style="text-transform: none;"></h2>
                    </div>

                    <!-- Email verification (Only becomes visible if needed) -->
                    <ul class="actions" id="verifyEmail" style="margin: 0 0 10px 0; display: none;">
                        <li><a onclick="verifyEmail()" title="Email Verification" class="button alt">Verify Email</a></li>
                    </ul>

                    <ul class="actions" style="margin: 10px 0 10px 0">
                        <li><a onclick="signOutUser()" title="Sign Out" class="button alt"><i class="material-icons">power_settings_new</i></a></li>
                        <li><a onclick="usrSettingsCloseOpen()" title="Profile Settings" class="button alt"><i class="material-icons" id="settingsBtn">settings</i></a></li>
                    </ul>
                    <div id="profileSettings" class="auth" style="display: none;">
                        <!-- Change name -->
                        <h2>User Settings</h2>
                        <button class="collapsible"> Update Name </button>
                        <div class="content">
                            <label class="authLabels" for="displayName">New display name:</label>
                            <input class="authInput" type="text" id="displayName" name="displayName">

                            <ul class="actions" style="margin: 10px 0 10px 0">
                                <li><a onclick="updateProfile()" title="Save Settings" class="button alt"><i class="material-icons">done</i></a></li>
                            </ul>
                        </div>

                        <!-- Change Password Portion -->
                        <button class="collapsible"> Change Password </button>
                        <div class="content" id="pwdChange">
                            <label class="authLabels" for="oldPwd">Old password: </label>
                            <input class="authInput" type="password" id="oldPwd" name="oldPwd">
                            <label class="authLabels" for="changePwd">New password: </label>
                            <input class="authInput" type="password" id="changePwd" name="changePwd">
                            <label class="authLabels" for="confirmChangePwd">Confirm password: </label>
                            <input class="authInput" type="password" id="confirmChangePwd" name="confirmChangePwd">

                            <ul class="actions" style="margin: 10px 0 10px 0">
                                <li><a onclick="changeUserPassword()" title="Save Settings" class="button alt"><i class="material-icons">done</i></a></li>
                            </ul>
                        </div>

                        <!-- Update Email Portion -->
                        <button class="collapsible"> Update Email </button>
                        <div class="content">
                            <label class="authLabels" for="emailChgPwd">Password: </label>
                            <input class="authInput" type="password" id="emailChgPwd" name="emailChgPwd">
                            <label class="authLabels" for="changeEmail">New email</label>
                            <input class="authInput" type="email" id="changeEmail" name="changeEmail">

                            <ul class="actions" style="margin: 10px 0 10px 0">
                                <li><a onclick="updateEmail()" title="Save Settings" class="button alt"><i class="material-icons">done</i></a></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Warning box (Normally hidden) -->
                    <div class="warningMsgBox auth" onclick="$('#warningBox2').fadeOut()" id="warningBox2" style="display: none;">
                        <h2 id="warnings2" class="msgBox" style="text-transform: none;"></h2>
                    </div>
                </div>

                <div id="loginArea" style="display: none">
                    <div class="auth" id="firebaseui-auth-container"></div>

                    <h3 style="margin-bottom: 5px; margin-top: 15px;">Email Sign-in</h3>

                    <div class="warningMsgBox auth" onclick="$('#warningBox1').fadeOut()" id="warningBox1">
                        <h2 id="warnings1" class="msgBox" style="text-transform: none;"></h2>
                    </div>

                    <div class="auth" id="emailLogin">
                        <div>
                            <label class="authLabels" for="username">Email:</label>
                            <input class="authInput" type="text" id="username" name="username">
                        </div>
                        <div>
                            <label class="authLabels" for="password">Password:</label>
                            <input class="authInput" type="password" id="password" name="password">
                        </div>
                        <a onclick="emailAuthLogin()" class="button alt submitBtn"><i class="material-icons">login</i></a>
                    </div>

                    <div id="newAccountHint">
                        <small> Or </small>
                        <a onclick="openAccountCreate()" class="button alt submitBtn">Create Account</a>
                    </div>

                    <div class="auth" id="newAccount" style="display: none;">
                        <div>
                            <label class="authLabels" for="newUsername">Email:</label>
                            <input class="authInput" type="text" id="newUsername" name="newUsername">
                        </div>
                        <div>
                            <label class="authLabels" for="newPassword">New Password:</label>
                            <input class="authInput" type="password" placeholder="7-64 characters starting with a letter" id="newPassword" name="NewPassword">
                        </div>
                        <div>
                            <label class="authLabels" for="confirmPassword">Confirm Password:</label>
                            <input class="authInput" type="password" id="confirmPassword" name="confirmPassword">
                        </div>
                        <a onclick="createNewAccount()" class="button alt submitBtn"><i class="material-icons">login</i></a>
                    </div>

                    <div id="backToLogin" style="display: none;">
                        <small> Or </small>
                        <a onclick="backToLogin()" class="button alt submitBtn">Login</a>
                    </div>

                </div>
            </div>
        </section>

            <!-- Footer -->
        <footer id="footer" class="wrapper">
            <div class="inner">
                <div class="copyright">
                    <p>This project is maintained by <a href="mailto:support@cryptoalgo.cf">@CryptoAlgo</a>.</p>
                </div>
            </div>
        </footer>

        <script>
            var coll = document.getElementsByClassName("collapsible");
            var i;

            for (i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.maxHeight){
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                } 
                });
            }
        </script>
    </body>
</html>